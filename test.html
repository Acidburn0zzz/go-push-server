<html>
<head>
<title>push notification test</title>

<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">

<script>

navigator.mozSetMessageHandler('push', function(e) {
    alert("Notification for " + e.pushEndpoint + ". Version="+e.version);
});

var version = 0;

function log(x) {
  var d = document.getElementById("d");
  d.innerHTML += "<p>" + x + "</p>";
}

function requestPush() {

  var req = navigator.pushNotification.register();

  req.onsuccess = function(e) {
    createLine(e.target.result.pushEndpoint);
  }

  req.onerror = function(e) {
   log("Error: " + JSON.stringify(e));
  }
}

function sendNotification(pushEndpoint) {
  var request = new XMLHttpRequest();

  request.onload = function() {
  };

  request.onerror = function(e) {
  };

  request.open("PUT", pushEndpoint, true);
  request.setRequestHeader('Content-type','application/x-www-form-urlencoded');
  request.send("version=" + version);
  version++;
}

function createLine(pushEndpoint) {
   var e = document.createElement("div");
   e.id = pushEndpoint;

   var t = document.createTextNode(pushEndpoint);
   e.appendChild(t);

   var button = document.createElement("button");
   var buttonText = document.createTextNode("Notify");
   button.appendChild(buttonText); 

   e.appendChild(button);
   button.addEventListener("click", function () {
       sendNotification(pushEndpoint);
     }, false);

   document.body.appendChild(e);
}

</script>
</head>
<body>
<button type="button" id="button" onClick="requestPush();">Request push</button>

<div id="d">
</div>
<p> To make things a bit easier, the "version" is shared for all notifications.
</body>
</html>
